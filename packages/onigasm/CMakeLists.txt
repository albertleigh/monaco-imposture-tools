cmake_minimum_required(VERSION 3.16)

set(COMPONENT_NAME OnigurumaAsm)

project(${COMPONENT_NAME})


set(CMAKE_CXX_STANDARD 20)

set(ONIGURUMA_DIRS ${CMAKE_SOURCE_DIR}/opt/oniguruma/src)

add_executable(${PROJECT_NAME} src/main.cc)

include_directories(${CMAKE_BINARY_DIR} ${SOURCE_INCLUDE_DIRS} ${ONIGURUMA_DIRS})
target_link_libraries(${PROJECT_NAME} onig)

#set(CMAKE_EXECUTABLE_SUFFIX ".js")

list(APPEND ONIG_ASM_LINK_FLAGS "--bind")
#list(APPEND ONIG_ASM_LINK_FLAGS "--memory-init-file=0")
#list(APPEND ONIG_ASM_LINK_FLAGS "-s WASM=0")
list(APPEND ONIG_ASM_LINK_FLAGS "-s NO_EXIT_RUNTIME=1")
list(APPEND ONIG_ASM_LINK_FLAGS "-s NO_FILESYSTEM=1")
list(APPEND ONIG_ASM_LINK_FLAGS "-s TOTAL_MEMORY=32MB")
list(APPEND ONIG_ASM_LINK_FLAGS "-s ALLOW_MEMORY_GROWTH=1")
list(APPEND ONIG_ASM_LINK_FLAGS "-s DEMANGLE_SUPPORT=1")
list(APPEND ONIG_ASM_LINK_FLAGS "-s EXPORTED_RUNTIME_METHODS=\"['ccall']\"")
list(APPEND ONIG_ASM_LINK_FLAGS "-s MODULARIZE=1")
list(APPEND ONIG_ASM_LINK_FLAGS "-s EXPORT_NAME=\"'${COMPONENT_NAME}'\"")
#list(APPEND ONIG_ASM_LINK_FLAGS "-o ${COMPONENT_NAME}.mjs")
list(JOIN ONIG_ASM_LINK_FLAGS " " ONIG_ASM_LINK_FLAGS)

#message(STATUS ${ONIG_ASM_LINK_FLAGS})

set_target_properties( ${PROJECT_NAME} PROPERTIES LINK_FLAGS ${ONIG_ASM_LINK_FLAGS})

install(TARGETS ${PROJECT_NAME} RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})